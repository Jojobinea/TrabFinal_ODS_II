
<!DOCTYPE html>
<html>
<head>
  <title>Enviar com MetaMask</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>EduQuiz ‚Äì Envio de Respostas com MetaMask</h2>
  <p id="status">‚è≥ Carregando...</p>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const answersRaw = urlParams.get("answers");
    const contractAddress = urlParams.get("address");
    const answers = JSON.parse(decodeURIComponent(answersRaw || "[]"));

    const abi = [
      {
        "inputs": [{"internalType": "string[]", "name": "answers", "type": "string[]"}],
        "name": "answerBatch",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    async function switchToSepolia() {
      const sepoliaParams = {
        chainId: "0xaa36a7",
        chainName: "Sepolia Testnet",
        nativeCurrency: {
          name: "SepoliaETH",
          symbol: "SepoliaETH",
          decimals: 18
        },
        rpcUrls: ["https://rpc.sepolia.org"],
        blockExplorerUrls: ["https://sepolia.etherscan.io"]
      };

      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: sepoliaParams.chainId }]
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [sepoliaParams]
          });
        } else {
          throw switchError;
        }
      }
    }

    async function sendTransaction() {
      const status = document.getElementById("status");

      if (typeof window.ethereum === 'undefined') {
        status.innerText = "‚ùå MetaMask n√£o detectada.";
        return;
      }

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);

        const network = await provider.getNetwork();
        if (network.chainId !== 11155111) {
          status.innerText = "üåê Trocando para Sepolia...";
          await switchToSepolia();
          location.reload();
          return;
        }

        const signer = provider.getSigner();
        const contract = new ethers.Contract(contractAddress, abi, signer);
        const tx = await contract.answerBatch(answers);
        status.innerText = "‚úÖ Transa√ß√£o enviada! Hash: " + tx.hash;
      } catch (err) {
        console.error(err);
        status.innerText = "Erro: " + err.message;
      }
    }

    sendTransaction();
  </script>
</body>
</html>
